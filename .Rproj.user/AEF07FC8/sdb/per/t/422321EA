{
    "contents" : "\\documentclass[serif]{beamer}\n\\usetheme{Boadilla}\n\\usepackage{graphicx}\n\\usepackage[final]{animate}\n\\usepackage{breqn}\n\\usepackage{xcolor}\n\\usepackage{booktabs}\n\\usepackage{tikz}\n\\usetikzlibrary{decorations.pathreplacing}\n\\usetikzlibrary{shapes,arrows,positioning,shadows}\n\\usepackage{subfig}\n\\usepackage{pgf}\n\\usepackage{caption}\n\n% change format of enumerated lists\n\\setbeamertemplate{enumerate items}[default]\n\\setbeamertemplate{navigation symbols}{}\n\n% change font size for figure captions\n\\setbeamerfont{caption}{size=\\scriptsize}\n\n% custom colors\n<<mypal, echo = F, results = 'asis', cache = T>>=\npal <- function(x) RColorBrewer::brewer.pal(x, 'GnBu')\nnum_col <- 5\n\nfor(i in 1:num_col){\n \n  col.nm <- paste0('mypal',i)\n  hexa <- paste0(gsub('#', '', pal(5)[i]))\n  cat(paste0('\\\\definecolor{', col.nm,'}{HTML}{',hexa,'}'))\n  \n}\n\nbg_col <- pal(num_col)[1]\n\npdf('fig/back_tmp.pdf',bg = bg_col)\nframe()\ninvisible(dev.off())\n@\n\n% title graphic\n<<echo = F, cache = TRUE, eval = F, message = F, results = 'hide'>>=\ndata(h2dat)\n\nnomod <-  filter(h2dat, resvar == 'no23') %>% \n  .$mod %>% \n  .[[1]]\n\nnhmod <- filter(h2dat, resvar == 'nh') %>% \n  .$mod %>% \n  .[[1]]\n\n# globals\nylab1 <- expression(paste(NO [2] ^ '-', ' / ', NO [3] ^ '2-', ' (mg ', L^-1, ')'))\nylab2 <- expression(paste(NH [4] ^ '+', ' (mg ', L^-1, ')'))\nflolab <- expression(paste('ln-Flow (', m^3, ' ', s^-1, ')'))\n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    plot.margin = unit(c(3, 3, 3, 3), 'pt')\n  )   \ncol_vec <- RColorBrewer::brewer.pal(9, 'Blues')[c(9, 8, 7)]\ndynacol_vec <- RColorBrewer::brewer.pal(9, 'Spectral')\nxlims <- range(nomod$date)\n\n# observed time series\ntoplo1 <- select(nomod, date, res) %>% \n  na.omit()\ntoplo2 <- select(nhmod, date, res) %>% \n  na.omit()\np1 <- ggplot(toplo1, aes(x = date, y = exp(res))) + \n  geom_line() + \n  mytheme + \n  scale_y_continuous(ylab1) +\n  theme(\n    axis.title.x = element_blank()\n  ) +\n  scale_x_date(limits = xlims) \np2 <- ggplot(toplo2, aes(x = date, y = exp(res))) + \n  geom_line() + \n  mytheme + \n  scale_y_continuous(ylab2) +\n  theme(\n    axis.title.x = element_blank()\n  ) +\n  scale_x_date(limits = xlims)  \n\n# prdnrmplots\np3 <- prdnrmplot(nomod, logspace = F, col_vec = col_vec, min_mo = 10) + \n  mytheme + \n  scale_y_continuous(ylab1) +\n  theme(\n    legend.position = 'none', \n    legend.title = element_blank(),\n    axis.title.x = element_blank()\n  ) +\n  scale_x_date(limits = xlims) \np4 <- prdnrmplot(nhmod, logspace = F, col_vec = col_vec, min_mo = 10) + \n  mytheme + \n  scale_y_continuous(ylab2) +\n  theme(\n    legend.position = 'none',\n    legend.title = element_blank(),\n    axis.title.x = element_blank()\n  ) +\n  scale_x_date(limits = xlims) \n\n# align widths of plots in first column, first two\npA <- ggplot_gtable(ggplot_build(p1))\npB <- ggplot_gtable(ggplot_build(p2))\npC <- ggplot_gtable(ggplot_build(p3))\npD <- ggplot_gtable(ggplot_build(p4))\n\nmaxWidth = unit.pmax(pA$widths[2:3], pB$widths[2:3], pC$widths[2:3], pD$widths[2:3])\n\n# Set the widths\npA$widths[2:3] <- maxWidth\npB$widths[2:3] <- maxWidth\npC$widths[2:3] <- maxWidth\npD$widths[2:3] <- maxWidth\n\npdf('fig/titlegraphic.pdf', height = 2, width = 18, family = 'serif')\ngrid.arrange(arrangeGrob(pA, pC, pB, pD, ncol = 4))\ndev.off()\n@\n\n\\tikzstyle{decision} = [diamond, draw, text width=6em, text badly centered, inner sep = 2pt, top color=white, bottom color=mypal3, drop shadow]\n\\tikzstyle{block} = [rectangle, draw, text width=10em, text centered, rounded corners, minimum height=3em, minimum width=8em, top color = white, bottom color=mypal4,  drop shadow]\n\\tikzstyle{declare} = [rectangle, draw, text width=10em, text centered, minimum height=3em, minimum width=8em, top color = white, bottom color=mypal5,  drop shadow]\n\n% knitr setup\n<<setup, include = F, cache = F>>=\n# set global chunk options\nlibrary(knitr)\nopts_chunk$set(fig.path='fig/', fig.align='center', fig.show='hold',message=F,echo=F,results='asis',dev='pdf',dev.args=list(family='serif'),fig.pos='!ht',warning=F)\noptions(replace.assign=T,width=90)\n@\n\n% dependent data\n<<dep_dat, include = F, cache = F>>=\nsource('R/funcs.R')\nlibrary(WRTDStidal)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(gridExtra)\nlibrary(grid)\nlibrary(purrr)\nlibrary(tidyr)\nlibrary(Hmisc)\nlibrary(ggrepel)\nlibrary(lubridate)\n@\n\n% get online bib file\n<<echo = FALSE, cache = FALSE>>=\nrefs <- httr::GET('https://raw.githubusercontent.com/fawda123/refs/master/refs.bib')\nrefs <- rawToChar(refs$content)\nwriteLines(refs, con = file('refs.bib'))\n@\n\n% figure used on title page\n<<title_fig, echo = F, results = 'hide', message = F, eval = T>>=\n# pdf('fig/title_plo.pdf', width = 12, height =3.5, family = 'serif')\n# print(p1)\n# invisible(dev.off())\n@\n\n\\setbeamercolor{title}{fg=mypal5} % main title\n\\setbeamercolor{frametitle}{fg=mypal4, bg=mypal2} % frame titles\n\\setbeamercolor{structure}{fg=mypal4} % bottom banner\n\\setbeamercolor{normal text}{fg=mypal5}\n\\usebackgroundtemplate{\\includegraphics[height=\\paperheight,width=\\paperwidth]{fig/back_tmp.pdf}}\n\n% macros\n\\newcommand{\\emtxt}[1]{\\textbf{\\textit{#1}}}\n\n\\begin{document}\n\n\\title[Understanding nitrogen pollution]{\\textbf{Quantitative approaches to understanding nitrogen pollution: Examples from the upper San Francisco Estuary}}\n\\author[M. Beck]{Marcus W. Beck, PhD}\n\n\\institute[USEPA]{USEPA National Health and Environmental Effects Research Laboratory, Gulf Ecology Division, \\href{mailto:beck.marcus@epa.gov}{beck.marcus@epa.gov}, Phone: 8509342480}\n\n\\date{Aug. 26, 2016}\n\n\\titlegraphic{\\includegraphics[width=\\linewidth]{fig/titlegraphic.pdf}}\n\n%%%%%%\n\\begin{frame}[shrink]\n\\vspace{0.2in}\n\\titlepage\n\\end{frame}\n\n\\section{Background}\n\n%%%%%%\n\\begin{frame}{\\textbf{Evaluating estuarine condition}}{\\textbf{How do we collect and use data?}}\nHow can we leverage monitoring data to develop our conceptual model of eutrophication? \\\\~\\\\\n\\onslide<+->\n\\begin{quote}\nEutrophication (noun) - an \\emtxt{increase} in the rate of supply of \\emtxt{organic matter} to an ecosystem\\\\\n\\hfill -- \\cite{Nixon95}\n\\end{quote}\n\\begin{center}\n\\scalebox{1}{\n\\begin{tikzpicture}[node distance = 4cm, auto, >=stealth]\n  \\onslide<+->{\n  \\node[block] (a) {Nutrient Loading};}\n  \\onslide<+->{\n\t\\node[decision] (b)  [right of=a] {Responses};\n \t\\draw[->] (a) -- (b);}\n  \\onslide<+->{\n  \\draw[decorate,decoration={brace,amplitude=10pt}] [right of=b] (2,-1.5) -- (2,1.5);\n  \\node[draw,align=left,draw=none] [right of=b] {\\textbf{Changes in:}\\\\ Chlorophyll\\\\ Primary Production\\\\ System Metabolism\\\\ Dissolved Oxygen};}\n\\end{tikzpicture}}\n\\end{center}\n\\vspace{-0.5cm}\\hspace*{15pt}\\scalebox{0.7}{\\hbox{\\tiny Adapted from \\cite{Cloern01}}}\\\\~\\\\\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Evaluating estuarine condition}}{\\textbf{How do we collect and use data?}}\n\\onslide<+->\n\\emtxt{Today's talk}: My experience evaluating monitoring data to inform our understanding of the eutrophication paradigm\\\\~\\\\\n\\onslide<+->\nWater quality trends in the Delta: \\\\~\\\\\n\\begin{itemize}\n\\item \\emtxt{Example 1}: Model theory and application \\\\~\\\\\n\\item \\emtxt{Example 2}: Trends over time \\\\~\\\\\n\\item \\emtxt{Example 3}: Selected case studies \\\\~\\\\\n\\end{itemize}\n\\onslide<+->\nCan we \\emtxt{develop} and \\emtxt{apply} methods that \\emtxt{link trends} with \\emtxt{causal events}?\n\\end{frame}\n\n\\section{Model theory and background}\n\n<<echo = F, cache = TRUE, eval = T, message = F, results = 'hide'>>=\ndata(\"mods_nolag\")\n\npal <- function(x) RColorBrewer::brewer.pal(x, 'GnBu')\nnum_col <- 5\n\n# model subset and plot subsets\nrow <- 7\nmod <- mods_nolag$mod[[row]]\nylab <-  expression(paste(\"DIN (mg \", L^-1, \")\"))\nxlims <- as.Date(c('1976-01-01', '2013-12-31'))\nylims <- c(0, 6)\n\nannuals <- prdnrmplot(mod, annuals = TRUE, plot = F) %>%\n  .$nrms %>% \n  filter(taus == 0.5)\nseasnls <- prdnrmplot(mod, annuals = FALSE, plot = F) %>%\n  .$nrms %>% \n  filter(taus == 0.5)\nresidus <- select(mod, date, res, fit0.5) %>% \n  mutate(resfit = exp(res) - exp(fit0.5)) %>% \n  na.omit()\n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = pal(num_col)[3]),\n    panel.grid.minor = element_line(colour = pal(num_col)[2])\n    )   \n\n# plots\np1 <- ggplot(na.omit(mod), aes(x = date, y = exp(res))) + \n  geom_line() +\n  mytheme +\n  scale_y_continuous(ylab, limits = c(0, 4)) + \n  scale_x_date('Time', limits = xlims)\n\np2 <- ggplot(annuals, aes(x = date, y = exp(nrms_value))) + \n  geom_line() + \n  mytheme +\n  scale_y_continuous(ylab, limits = c(0, 4)) + \n  theme(\n    axis.title.x = element_text(size = 8),\n    axis.title.y = element_text(size = 8)\n    ) + \n  scale_x_date('Time', limits = xlims) + \n  ggtitle('Annual')\n\np3 <- ggplot(seasnls, aes(x = date, y = exp(nrms_value))) + \n  geom_line() + \n  mytheme +\n  scale_y_continuous(ylab) + \n  scale_x_date('Time', limits = xlims) + \n  theme(\n    axis.title.x = element_text(size = 8),\n    axis.title.y = element_text(size = 8)\n    ) + \n  ggtitle('Seasonal')\n\np4 <- ggplot(residus, aes(x = date, y = resfit)) + \n  geom_point() + \n  geom_hline(aes(yintercept = 0)) + \n  mytheme +\n  scale_y_continuous(ylab) + \n  theme(\n    axis.title.x = element_text(size = 8),\n    axis.title.y = element_text(size = 8)\n    ) + \n  scale_x_date('Time', limits = xlims) + \n  ggtitle('Residual')\n\np5 <- dynaplot(mod, mo = 1, logspace = F, years = c(1976, 2000, 2013), col_vec = 'black') + \n  mytheme +\n  theme(\n    legend.position = 'none', \n    strip.text.x = element_blank(),\n    axis.title.x = element_text(size = 8),\n    axis.title.y = element_text(size = 8)\n    ) + \n  scale_y_continuous(ylab) + \n  scale_x_continuous('Flow') + \n  ggtitle('Flow effects')\n\npdf('fig/ts_ex.pdf', height = 2, width = 12, family = 'serif')\np1\ndev.off()\n\nht <- 1.75\nwd <- 4.5\n\npdf('fig/schematic2.pdf', height = ht, width = wd, family = 'serif')\np2\ndev.off()\npdf('fig/schematic3.pdf', height = ht, width = wd, family = 'serif')\np3\ndev.off()\npdf('fig/schematic4.pdf', height = ht, width = wd, family = 'serif')\np4\ndev.off()\npdf('fig/schematic5.pdf', height = ht, width = wd, family = 'serif')\np5\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}[t]{\\textbf{Model theory and background}}{\\textbf{WRTDS adaptation for tidal waters}}\n{\\bf \\centerline{Observed data represents effects of many processes}}\n\\vspace{0.15in}\n\\centerline{\\includegraphics[width = \\textwidth]{fig/ts_ex.pdf}}\n\\vspace{0.15in}\n\\begin{columns}[t]\n\\begin{column}{0.3\\textwidth}\n{\\bf \\underline{\\emtxt{Climate}}}\\\\\nprecipitation\\\\\ntemperature\\\\\nwind events\\\\\nENSO effects\n\\end{column}\n\\begin{column}{0.3\\textwidth}\n{\\bf \\underline{\\emtxt{Local}}}\\\\\nlight/turbidity\\\\\nresidence time\\\\\ninvasive species\\\\\ntrophic effects\n\\end{column}\n\\begin{column}{0.3\\textwidth}\n{\\bf \\underline{\\emtxt{Regional/historical}}}\\\\\nwatershed inputs\\\\\npoint sources\\\\\nmanagement actions\nflow changes\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}[t]{\\textbf{Model theory and background}}{\\textbf{WRTDS adaptation for tidal waters}}\n\\onslide<+->\n{\\bf \\centerline{Observed data represents effects of many processes}}\n\\vspace{0.15in}\n\\centerline{\\includegraphics[width = \\textwidth]{fig/ts_ex.pdf}}\n\\centerline{Models should describe components to evaluate effects}\n\\vspace{-0.1in}\n\\begin{columns}[t]\n\\begin{column}{0.5\\textwidth}\n\\onslide<+->{\n\\centerline{\\includegraphics[width = 0.8\\textwidth]{fig/schematic2.pdf}}\n\\centerline{\\includegraphics[width = 0.8\\textwidth]{fig/schematic3.pdf}}\n}\n\\end{column}\n\\begin{column}{0.5\\textwidth}\n\\onslide<+->{\n\\centerline{\\includegraphics[width = 0.8\\textwidth]{fig/schematic4.pdf}}\n\\centerline{\\includegraphics[width = 0.8\\textwidth]{fig/schematic5.pdf}}\n}\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}[t]{\\textbf{Model theory and background}}{\\textbf{WRTDS adaptation for tidal waters}}\n\\onslide<+->\n\\emtxt{Problem:} Response endpoints of eutrophication vary naturally over time and with discharge or tidal patterns\\\\~\\\\\n\\emtxt{Solution:} Develop a model that accounts for changes in relationships between drivers of pollution over time\\\\~\\\\\n\\onslide<+->\nThe \\emtxt{weighted regression (WRTDS)} approach models pollutants in rivers as a function of \\emtxt{time}, \\emtxt{discharge}, and \\emtxt{season} \\cite{Hirsch10}\\\\~\\\\\n\\onslide<+->\n\\emtxt{Adaptation:} Applied to Tampa Bay \\cite{Beck15}, further validated/compared in Patuxent Estuary [Beck and Murphy, In review]\n\\end{frame}\n\n<<wtex, echo = F, results = 'hide', message = F, eval = F>>=\nload('data/epc_tb_dat.RData')\nload('data/epc_est_act.RData')\n\npal <- function(x) RColorBrewer::brewer.pal(x, 'GnBu')\nnum_col <- 5\n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = pal(num_col)[3]),\n    panel.grid.minor = element_line(colour = pal(num_col)[2])\n    )   \n\ndat.in <- data.frame(tb.dat, pred = epc.est.act$fit.md)\ndat.in <- dat.in[dat.in$year>=2000 & dat.in$year <=2010,]\ndat.in <- dat.in[dat.in$seg=='Hillsborough Bay',]\n\nrow_exs <- 1:nrow(dat.in)\n\npdf('fig/wtex.pdf', height = 3.75, width = 8, family = 'serif')\nfor(row_ex in row_exs){\n  \n  cat(row_ex, '\\t')\n  \n  ref.in<-dat.in[row_ex,]\n\n  ##\n  #random year, month, load, one year, wts separated\n  ref.wt<-wt.fun(ref.in,dat.in,all=T)\n  yr.sub<-format(dat.in$date.f,'%Y')==ref.in$year\n  titles<-with(\n    ref.in,\n    c(as.character(month.name),year,substitute(italic(Sal[ff])~sal,list(sal=as.character(round(ref.in$sal.ref,2)))),\n    'All'),\n  )\n  \n  p1.dat<-data.frame(Month=dat.in$date.f[yr.sub],Wt=ref.wt[yr.sub,1])\n  p1<-ggplot(p1.dat,aes(x=Month,y=Wt)) + \n    geom_line() + \n    ggtitle(titles[[1]]) +\n    scale_y_continuous(name=element_blank(),limits=c(0,1)) +\n    scale_x_date(date_labels=\"%b\", name=element_blank()) +\n    mytheme\n  \n  p2.dat<-data.frame(Date=dat.in$date.f,Wt=ref.wt[,2])\n  p2<-ggplot(p2.dat,aes(x=Date,y=Wt)) + \n    geom_line() + \n    scale_x_date(name=element_blank(),breaks = as.Date(range(dat.in$date.f)), date_labels = \"%Y\") +\n    scale_y_continuous(name=element_blank(),limits=c(0,1)) +\n    ggtitle(titles[[2]]) +\n    mytheme\n  \n  #p3 xlims\n  p3x0 <- paste0(as.numeric(ref.in$year)-2,'-01-01')\n  p3x1 <- paste0(as.numeric(ref.in$year)+2,'-01-01')\n  p3.dat<-data.frame(Date=dat.in$date.f,Wt=ref.wt[,3],\n    sal.ref=dat.in$sal.ref)\n  yint<-which(dat.in$sal.ref==ref.in$sal.ref)\n  p3<-ggplot(p3.dat,aes(x=Date,y=Wt)) + \n    geom_line() + \n    #geom_line(aes(y=sal.ref),col='red') + \n    geom_hline(yintercept=p3.dat[yint,'sal.ref'],col='black',lwd=1.4,lty=2) +\n    scale_y_continuous(name=element_blank(),limits=c(0,1)) +\n    scale_x_date(name=element_blank(),limits=as.Date(c(p3x0,p3x1)), breaks = as.Date(c(p3x0,p3x1)), date_labels = \"%Y\") +\n    ggtitle(titles[[3]]) +\n    mytheme\n  \n  p4.dat<-data.frame(Date=dat.in$date.f,Wt=ref.wt[,1]*ref.wt[,2]*ref.wt[,3])\n  p4<-ggplot(p4.dat,aes(x=Date,y=Wt)) + \n    geom_line() + \n    scale_x_date(name=element_blank(),breaks = as.Date(range(dat.in$date.f)), date_labels = \"%Y\") +\n    scale_y_continuous(name=element_blank(),limits=c(0,1)) +\n    ggtitle(titles[[4]]) + \n    mytheme\n  \n  ##\n  #ggplot showing point size and color in relation to total weight\n  p.dat<-data.frame(\n    Date=dat.in$date.f,\n    Chla_ugl=dat.in$Chla_ugl,\n    pred = dat.in$pred,\n    sal.ref=dat.in$sal.ref,\n    month.wt=ref.wt[,1],\n    year.wt=ref.wt[,2],\n    sal.wt=ref.wt[,3],\n    all.wt=ref.wt[,1]*ref.wt[,2]*ref.wt[,3]\n  )\n  \n  title.val<-substitute(\n    mo~yr~italic(Sal[ff])~sal,\n    list(mo=as.character(ref.in$month.name),yr=paste0(ref.in$year,', '),sal=as.character(round(ref.in$sal.ref,2)))\n    )\n   \n  # predicted values to plot\n  preds <- p.dat[1:row_ex, ]\n  \n  ylabs<-expression(paste('Chlorophyll-',italic(a),' (',italic('\\u03bc'),'g ',L^-1,')'))\n  p.dat.plo<-ggplot(p.dat,aes(x=Date,y=Chla_ugl)) +\n    geom_point(aes(size=all.wt,colour=all.wt)) +\n    scale_y_continuous(limit=c(0,4.5),name=ylabs) +\n    scale_x_date(name=element_blank()) +\n    scale_size(range=c(2,12)) +\n    geom_line(data = preds, aes(x = Date, y = pred), size = 1.3, alpha = 0.6) +\n    ggtitle(title.val) + \n    mytheme +\n    scale_colour_gradientn(colours = pal(5)[2:5]) +\n    theme(legend.position = 'none')\n  \n  grid.arrange(\n      p.dat.plo,\n      arrangeGrob(p1,p2,p3,p4,nrow=2,left=textGrob('Weights',rot=90)), ncol = 2\n    )\n}\n\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Model theory and background}}{\\textbf{WRTDS adaptation for tidal waters}}\nHow does weighted regression work?\n\\begin{center}\n\\animategraphics[controls,width=\\linewidth]{10}{fig/wtex}{}{} %frame rate is 12 per/sec\n\\end{center}\n\\end{frame}\n \n<<map, echo = F, include = F, results = 'hide'>>=\n# load required data\ndata(delt_dat)\ndata(delt_map)\n\npal <- function(x) RColorBrewer::brewer.pal(x, 'GnBu')\nnum_col <- 5\ncols <- c('#D53E4F', '#4DAF4A', '#377EB8') # red, green, blue\n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = alpha(pal(num_col)[3], 0.6)),\n    panel.grid.minor = element_line(colour = alpha(pal(num_col)[2], 0.6)), \n    axis.title.x = element_blank(), \n    axis.title.y = element_blank()\n    )   \n\n##\n# get a bounding box for the stations\nstatmeta <- select(delt_dat, Site_Code, Latitude, Longitude) %>% \n  unique\n\n# flo variable locations\nsacsjr <- data.frame(\n  flovar = c('Sacramento R.', 'San Joaquin R.'), \n  Latitude = c(38.45602, 37.67604), \n  Longitude = c(-121.5013, -121.2663)\n  )\n\n# bounding box\nbuffx <- 0\nbuffy <- 0\nlims<- select(statmeta, -Site_Code) %>% \n  rbind(sacsjr[, !names(sacsjr) %in% 'flovar']) %>% \n  apply(., 2, function(x) range(x, na.rm = TRUE))\nlims <- c(\n  (1 + buffx) * lims[1, 2], \n  (1 - buffy) * lims[1, 1], \n  (0.9995 - buffx) * lims[2, 2], \n  (1 + buffy) * lims[2, 1]\n  )    \nnames(lims) <- c('left', 'bottom', 'right', 'top')\n\n# base delta map\npdelta <- ggplot(delt_map, aes(x = long, y = lat)) + \n  geom_polygon(aes(group = group, fill = hole), colour = 'cornflowerblue') +\n  mytheme + \n  coord_fixed(ratio = 1, xlim = lims[c(1, 3)], ylim = lims[c(2, 4)]) +\n  scale_fill_manual(values = c(\"cornflowerblue\", pal(num_col)[1]), guide = \"none\") +\n  geom_label(data = sacsjr[1, ], aes(x = Longitude, y = Latitude, label = flovar), fill = cols[1]) +\n  geom_label_repel(data = sacsjr[2, ], aes(x = Longitude, y = Latitude, label = flovar), fill = cols[1],\n    point.padding = unit(0.4, \"lines\"), force = 2.5) +\n  geom_label(data = statmeta, aes(x = Longitude, y = Latitude, label = Site_Code), fill = cols[2])\n\npdf('fig/stations.pdf', height = 3.5, width = 4.5, family = 'serif')\npdelta\ndev.off()\n@\t     \n \n%%%%%%\n\\begin{frame}{\\textbf{Model theory and background}}{\\textbf{WRTDS adaptation for tidal waters}} \n{\\bf \\centerline{Application to Delta}}\n\\begin{columns}\n\\begin{column}{0.45\\textwidth}\n\\begin{itemize}\n\\item Nine stations (three Suisun, three middle, three delta) \\\\~\\\\\n\\item Three analytes (DIN, ammonium, nitrite/nitrate), two flow records \\\\~\\\\\n\\item Four decades of data, 1976-2013\n\\end{itemize}\n\\end{column}\n\\begin{column}{0.5\\textwidth}\n\\begin{figure}\n\\begin{center}\n\\includegraphics[width = \\textwidth]{fig/stations.pdf}\n\\caption{Stations (green) and flow estimates (red) modelled with WRTDS}\n\\end{center}\n\\end{figure}\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n\\section{Trends}\n\n<<eval = F, echo = F, results = 'hide', message = F>>=\ndata(delt_dat)\ndata(mods_nolag)\ndata(delt_map)\n\npal <- RColorBrewer::brewer.pal(5, 'GnBu')\n\ncolfun <- function(vals, pal = 'Spectral', ncol = 10){\n\n  pal <- rev(RColorBrewer::brewer.pal(ncol, pal))\n  palfun <- colorRamp(pal)\n  \n  valscl <- (vals - min(vals, na.rm = T)) / diff(range(vals, na.rm = T))\n  valna <- is.na(valscl)\n  cols <- palfun(valscl)\n  out <- rep(NA, length = length(valscl))\n  out[!valna] <- rgb(cols[!valna, ], maxColorValue=256)\n  \n  return(out)\n  \n}\n\n##\n# get a bounding box for the stations\nstatmeta <- select(delt_dat, Site_Code, Latitude, Longitude) %>% \n  unique\n\n# aggregate all model fits by month, long format, add locations\nmodagg <- mods_nolag %>% \n  filter(resvar %in% 'din') %>% \n  mutate(mod = \n    map(mod, function(x){\n      out <- group_by(x, year, month) %>% \n      summarise(\n        fit = median(fit0.5, na.rm = T)\n        )\n      out\n    })\n  ) %>% \n  select(Site_Code, resvar, mod) %>% \n  unnest %>% \n  unite(date, year:month, sep = '-', remove = F) %>% \n  filter(year %in% c(1980:1989)) %>% \n  mutate(\n    valsz = scales::rescale(fit, c(2, 17)),\n    valcl = colfun(fit),\n    date = as.Date(paste0(date, '-1'), format = '%Y-%m-%d'),\n    month = factor(month, levels = c(1:12), labels = c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'))\n    ) %>% \n  unite(datetxt, month:year, sep = ' ') %>% \n  left_join(., statmeta, by = 'Site_Code') \n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = alpha(pal[3], 0.6)),\n    panel.grid.minor = element_line(colour = alpha(pal[2], 0.6)), \n    axis.title.x = element_blank(), \n    axis.title.y = element_blank()\n    )   \n\n# bounding box\nbuffx <- 0\nbuffy <- 0\nlims<- select(statmeta, -Site_Code) %>% \n  apply(., 2, function(x) range(x, na.rm = TRUE))\nlims <- c(\n  (1 + buffx) * lims[1, 2], \n  (1 - buffy) * lims[1, 1], \n  (0.9995 - buffx) * lims[2, 2], \n  (1 + buffy) * lims[2, 1]\n  )    \nnames(lims) <- c('left', 'bottom', 'right', 'top')\n\nmoyrs <- unique(modagg$date)\n\npdf('fig/trnds.pdf', height = 4.5, width = 9, family = 'serif')\nfor(moyr in moyrs){\n\n  cat(moyr, '\\t')\n  toplo <- filter(modagg, date %in% moyr)\n  \n  p1 <- ggplot(delt_map, aes(x = long, y = lat)) + \n    geom_polygon(aes(group = group, fill = hole), colour = 'cornflowerblue') +\n    mytheme + \n    coord_fixed(ratio = 1, xlim = lims[c(1, 3)], ylim = lims[c(2, 4)]) +\n    scale_fill_manual(values = c(\"cornflowerblue\", pal[1]), guide = \"none\") +\n    geom_text(data = toplo, aes(x = Longitude + 0.07, y = Latitude, label = Site_Code)) + \n    geom_point(data = toplo, aes(x = Longitude, y = Latitude), \n      colour = toplo$valcl, \n      size = toplo$valsz,\n      alpha = 0.85\n      ) + \n    ggtitle(unique(toplo$datetxt))\n  p2 <- ggplot(modagg, aes(x = date, y = fit)) + \n    geom_line() +\n    mytheme + \n    theme(\n      panel.grid.minor = element_blank(),\n      axis.title.y = element_text(angle = 90),\n      axis.text.y = element_text(size = 8)\n    ) +\n    scale_x_date(expand = c(0, 0)) + \n    geom_vline(xintercept = as.numeric(moyr)) + \n    geom_point(data = toplo, aes(x = date, y = fit), size = 2.5) + \n    facet_grid(Site_Code ~ .) + \n    scale_y_continuous('ln-DIN')\n\n  grid.arrange(p2, p1, ncol = 2, widths = c(0.5, 1))\n  \n}\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Trends over time}}{\\textbf{Nitrogen dynamics in the Delta}} \n{\\bf \\centerline{Predicted DIN trends, 1980-1990}}\n\\vspace{0.05in}\n\\centerline{\n\\animategraphics[controls,width=\\linewidth]{7}{fig/trnds}{}{} %frame rate is 10 per/sec\n}\n\\end{frame}\n\n<<eval = F, echo = F, results = 'hide', message = F>>=\nstrip_col <- alpha('#377EB8', 0.5)\n\npdf('fig/trndsperdin.pdf', height = 6, width = 9, family = 'serif')\ntrnd_map(res = 'din', strp_fl = strip_col, leg = T)\ndev.off()\n\npdf('fig/trndspernh.pdf', height = 6, width = 9, family = 'serif')\ntrnd_map(res = 'nh', strp_fl = strip_col, leg = T)\ndev.off()\n\npdf('fig/trndsperno23.pdf', height = 6, width = 9, family = 'serif')\ntrnd_map(res = 'no23', strp_fl = strip_col, leg = T)\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Trends over time}}{\\textbf{Nitrogen dynamics in the Delta - DIN}} \n\\centerline{\\includegraphics[width = 0.93\\textwidth, page = 2]{fig/trndsperdin.pdf}}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Trends over time}}{\\textbf{Nitrogen dynamics in the Delta - ammonium}} \n\\centerline{\\includegraphics[width = 0.93\\textwidth, page = 2]{fig/trndspernh.pdf}}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Trends over time}}{\\textbf{Nitrogen dynamics in the Delta - nitrite/nitate}} \n\\centerline{\\includegraphics[width = 0.93\\textwidth, page = 2]{fig/trndsperno23.pdf}}\n\\end{frame}\n\n<<echo = F, cache = TRUE, eval = T, message = F, results = 'hide'>>=\ndata(\"mods_nolag\")\n\npal <- function(x) RColorBrewer::brewer.pal(x, 'GnBu')\nnum_col <- 5\n\n# model subset and plot subsets\nrow <- 7\nmod <- mods_nolag$mod[[row]]\nylab <-  expression(paste(\"DIN (mg \", L^-1, \")\"))\nxlims <- as.Date(c('1976-01-01', '2013-12-31'))\nylims <- c(0, 6)\n\nannuals <- prdnrmplot(mod, annuals = TRUE, plot = F) %>%\n  .$nrms %>% \n  filter(taus == 0.5)\nseasnls <- prdnrmplot(mod, annuals = FALSE, plot = F) %>%\n  .$nrms %>% \n  filter(taus == 0.5)\nresidus <- select(mod, date, res, fit0.5) %>% \n  mutate(resfit = exp(res) - exp(fit0.5)) %>% \n  na.omit()\n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = pal(num_col)[3]),\n    panel.grid.minor = element_line(colour = pal(num_col)[2])\n    )   \n\n# plots\np1 <- ggplot(na.omit(mod), aes(x = date, y = exp(res))) + \n  geom_line() +\n  mytheme +\n  theme(\n    axis.title.x = element_blank(), \n    axis.text.x = element_blank()\n  ) + \n  scale_y_continuous('Obs DIN', limits = c(0, 4)) + \n  scale_x_date(limits = xlims)\np2 <- ggplot(na.omit(mod), aes(x = date, y = exp(fit0.5))) + \n  geom_line() +\n  mytheme +\n  scale_y_continuous('Pred DIN', limits = c(0, 4)) + \n  scale_x_date('Time', limits = xlims)\n\npdf('fig/ts_ex2.pdf', height = 3.5, width = 12, family = 'serif')\ngrid.arrange(p1, p2, ncol = 1, heights = c(0.85, 1), left = ylab)\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Trends over time}}{\\textbf{Nitrogen dynamics in the Delta - nitrite/nitate}} \nThe \\emtxt{WRTDS} approach lets us model historical trends in relation to \\emtxt{time}, \\emtxt{discharge}, and \\emtxt{season}\\\\~\\\\\nPredicted trends follow observed... how can we leverage the results to better understand important processes? \\\\~\\\\\n\\centerline{\\includegraphics[width = \\textwidth]{fig/ts_ex2.pdf}}\n\\end{frame}\n\n\\section{Selected case studies}\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{}}\n\\onslide<+->\nTwo examples demonstrate the utility of WRTDS adaptation to tidal waters: \\\\~\\\\\n\\begin{itemize}\n\\item Effects of wastewater treatment at P8 \\\\~\\\\\n\\item Effects of biological invasion in Suisun Bay\\\\~\\\\\n\\end{itemize}\n\\onslide<+->\nEach shows how \\emtxt{model components} describe \\emtxt{processes} \\\\~\\\\\nUses \\emtxt{WRTDStidal} package for R\n\\end{frame}\n\n<<echo = F, cache = TRUE, eval = F, message = F, results = 'hide'>>=\ndata(potw_load)\n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    plot.margin = unit(c(0, 3, 3, 3), 'pt'),\n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    axis.title.x = element_blank()\n  )   \n\nlncol <- RColorBrewer::brewer.pal(9, 'Set1')[2]\n\ntoplo1 <- filter(potw_load, loc %in% 'tracy' & var %in% c('tn'))\ntoplo2 <- filter(potw_load, loc %in% 'tracy' & var %in% c('nh4', 'no3', 'orgn'))\n\nylab <- expression(paste(\"Total nitrogen load (kg \", d^-1, \")\"))\nleglabs <- list(\n  expression(NH [4] ^ '+'),\n  expression(NO [3] ^ '2-'),\n  expression('organic N')\n  )\n\nlndate <- as.Date('2007/05/01')\n\np1 <- ggplot(toplo1) + \n  geom_line(colour = lncol, aes(x = date, y = val)) + \n  scale_x_date(expand = c(0, 0)) + \n  scale_y_continuous(ylab, expand = c(0, 0), limits = c(50, 850)) + \n  geom_vline(xintercept = as.numeric(lndate), linetype = 'dashed') +\n  geom_label_repel(\n    data = data.frame(x = lndate, y = 600), \n    aes(x, y, label = 'WWTP upgrades'), \n    box.padding = grid::unit(2, \"lines\"), \n    nudge_x = 1\n    ) + \n  mytheme\n\np2 <- ggplot(toplo2, aes(x = date, y = val, group = var, fill = var)) + \n  geom_area(stat = 'identity', position = 'fill') + \n  scale_x_date(expand = c(0, 0)) + \n  scale_fill_brewer(palette = 'Blues', labels = leglabs) + \n  scale_y_continuous('% of total nitrogen', expand = c(0, 0)) + \n  geom_vline(xintercept = as.numeric(lndate), linetype = 'dashed') +\n  mytheme + \n  theme(\n    legend.position = 'top', \n    legend.title = element_blank()\n    )\n\n# align widths of plots in first column, first two\npA <- ggplot_gtable(ggplot_build(p1))\npB <- ggplot_gtable(ggplot_build(p2))\nmaxWidth = unit.pmax(pA$widths[2:3], pB$widths[2:3])\n\n# Set the widths\npA$widths[2:3] <- maxWidth\npB$widths[2:3] <- maxWidth\n\npdf('fig/tracy.pdf', height = 5, width = 9, family = 'serif')\ngrid.arrange(pA, pB, ncol = 1, heights = c(0.8, 1))\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of wastewater treatment upgrades}}\nHow can model information be linked to causation?\n\\vspace{0.1in}\n\\begin{figure}\n\\centerline{\\includegraphics[width = 0.8\\textwidth]{fig/tracy.pdf}}\n\\caption{Nitrogen load measurements (kg d$^{-1}$) at the Tracy Wastewater Treatment Plant.  Wastewater discharge requirements were implemented in May, 2007.}\n\\end{figure}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of wastewater treatment upgrades}}\n\\emtxt{Hypothesis}: Response of nutrient concentrations at P8 is linked to upstream WWTP upgrades \\\\~\\\\\nWe should be able to \\emtxt{predict}: \\\\~\\\\\n\\begin{itemize}\n\\item A flow-normalized annual trend concurrent with WWTP upgrades \\\\~\\\\\n\\item Variation in nitrogen species response depending on change in load outputs\n\\end{itemize}\n\\end{frame}\n\n<<echo = F, cache = TRUE, eval = F, message = F, results = 'hide'>>=\ndata(h2dat)\n\nnomod <-  filter(h2dat, resvar == 'no23') %>% \n  .$mod %>% \n  .[[1]]\n\nnhmod <- filter(h2dat, resvar == 'nh') %>% \n  .$mod %>% \n  .[[1]]\n\n# globals\nylab1 <- expression(paste(NO [2] ^ '-', ' / ', NO [3] ^ '2-', ' (mg ', L^-1, ')'))\nylab2 <- expression(paste(NH [4] ^ '+', ' (mg ', L^-1, ')'))\nflolab <- expression(paste('ln-Flow (', m^3, ' ', s^-1, ')'))\n\n# default theme\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    plot.margin = unit(c(3, 3, 3, 3), 'pt')\n  )   \ncol_vec <- RColorBrewer::brewer.pal(9, 'Blues')[c(9, 8, 7)]\ndynacol_vec <- RColorBrewer::brewer.pal(9, 'Spectral')\nxlims <- range(nomod$date)\n\n# observed time series\ntoplo1 <- select(nomod, date, res) %>% \n  na.omit()\ntoplo2 <- select(nhmod, date, res) %>% \n  na.omit()\np1 <- ggplot(toplo1, aes(x = date, y = exp(res))) + \n  geom_line() + \n  mytheme + \n  scale_y_continuous(ylab1) +\n  theme(\n    axis.title.x = element_blank()\n  ) +\n  scale_x_date(limits = xlims) \np2 <- ggplot(toplo2, aes(x = date, y = exp(res))) + \n  geom_line() + \n  mytheme + \n  scale_y_continuous(ylab2) +\n  theme(\n    axis.title.x = element_blank()\n  ) +\n  scale_x_date(limits = xlims)  \n\n# prdnrmplots\np3 <- prdnrmplot(nomod, logspace = F, col_vec = col_vec, min_mo = 10) + \n  mytheme + \n  scale_y_continuous(ylab1) +\n  theme(\n    legend.position = 'top', \n    legend.title = element_blank(),\n    axis.title.x = element_blank(),\n    plot.margin = grid::unit(c(6, 6, 6, 6), 'pt')\n  ) +\n  scale_x_date(limits = xlims) \npleg1 <- g_legend(p3)\np3 <- p3 + theme(legend.position = 'none')\np4 <- prdnrmplot(nhmod, logspace = F, col_vec = col_vec, min_mo = 10) + \n  mytheme + \n  scale_y_continuous(ylab2) +\n  theme(\n    legend.position = 'none',\n    legend.title = element_blank(),\n    axis.title.x = element_blank(),\n    plot.margin = grid::unit(c(6, 6, 6, 6), 'pt')\n  ) +\n  scale_x_date(limits = xlims) \n\n# dynaplots\np5 <- dynaplot(nomod, logspace = F, col_vec = dynacol_vec, month = c(1, 4, 7, 10), floscl = F) + \n  mytheme + \n  scale_y_continuous(ylab1) +\n  theme(\n    legend.position = 'top', \n    legend.title = element_blank()\n  ) +\n  scale_x_continuous(flolab) + \n  guides(colour = guide_colourbar(barheight = 0.5, barwidth = 10))\npleg2 <- g_legend(p5)\np5 <- p5 + theme(legend.position = 'none')\np6 <- dynaplot(nhmod, logspace = F, col_vec = dynacol_vec, month = c(1, 4, 7, 10), floscl = F) + \n  mytheme + \n  scale_y_continuous(ylab2) +\n  scale_x_continuous(flolab) +\n  theme(\n    legend.position = 'none', \n    legend.title = element_blank()\n  )\n\n# align widths of plots in first column, first two\npA <- ggplot_gtable(ggplot_build(p1))\npB <- ggplot_gtable(ggplot_build(p2))\npC <- ggplot_gtable(ggplot_build(p3))\npD <- ggplot_gtable(ggplot_build(p4))\npE <- ggplot_gtable(ggplot_build(p5))\npF <- ggplot_gtable(ggplot_build(p6))\n\nmaxWidth = unit.pmax(pA$widths[2:3], pB$widths[2:3], pC$widths[2:3], pD$widths[2:3], pE$widths[2:3], pF$widths[2:3])\n\n# Set the widths\npA$widths[2:3] <- maxWidth\npB$widths[2:3] <- maxWidth\npC$widths[2:3] <- maxWidth\npD$widths[2:3] <- maxWidth\npE$widths[2:3] <- maxWidth\npF$widths[2:3] <- maxWidth\n\npdf('fig/p8obs.pdf', height = 2, width = 9, family = 'serif')\ngrid.arrange(pA, pB, ncol = 2) \ndev.off()\n\npdf('fig/p8prdnrm.pdf', height = 2.4, width = 9, family = 'serif')\ngrid.arrange(\n  pleg1,\n  arrangeGrob(pC, pD, ncol = 2), \n  ncol = 1, heights = c(0.25, 1)\n)\ndev.off()\n\npdf('fig/p8dyna.pdf', height = 4.5, width = 9, family = 'serif')\ngrid.arrange(\n  pleg2, \n  arrangeGrob(pE, pF, ncol = 2), \n  ncol = 1, heights = c(0.25, 2)\n)\ndev.off()\n\npdf('fig/p8dyna_thumb.pdf', height = 4.5, width = 4.5, family = 'serif')\ngrid.arrange(\n  pleg2, \n  pF,\n  ncol = 1, heights = c(0.25, 2)\n)\ndev.off()\n\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of wastewater treatment upgrades}}\n\\onslide<+->\n\\begin{figure}\n\\centerline{\\includegraphics[width = \\textwidth]{fig/p8obs.pdf}}\n\\caption{Observed nitrogen time series at P8}\n\\end{figure}\n\\onslide<+->\n\\vspace{-0.35in}\n\\begin{figure}\n\\centerline{\\includegraphics[width = \\textwidth]{fig/p8prdnrm.pdf}}\n\\caption{Annual predicted and flow-normalized nitrogen from WRTDS.}\n\\end{figure}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of wastewater treatment upgrades}}\n\\vspace{0.1in}\n\\begin{figure}\n\\centerline{\\includegraphics[width = \\textwidth]{fig/p8dyna.pdf}}\n\\caption{Nitrogen relationships with flow over time at P8.}\n\\end{figure}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of wastewater treatment upgrades}}\nResults at P8 were linked to WWTP upgrades:\n\\begin{columns}\n\\begin{column}{0.45\\textwidth}\n\\begin{itemize}\n\\item Flow-normalized changes in ammonium, also nitrite/nitrate \\\\~\\\\\n\\item Ammonium reductions occurred in winter \\\\~\\\\\n\\item Largest response of ammonium at low flow... but not in summer\n\\end{itemize}\n\\end{column}\n\\begin{column}{0.4\\textwidth}\n\\vspace{0.3in}\n\\centerline{\\includegraphics[width = \\textwidth]{fig/p8dyna_thumb.pdf}}\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of biological invasion in Suisun Bay}}\n\\emtxt{Hypothesis}: Biological invasions by benthic filter feeders have shifted abundance and composition of phytoplankton in Suisun Bay \\\\~\\\\\nWe should be able to \\emtxt{predict}: \\\\~\\\\\n\\begin{itemize}\n\\item A decline in annual, flow-normalized chlorophyll following increase in invaders\\\\~\\\\\n\\item Varying effects of flow given complex relationships between chlorophyll and invaders\n\\end{itemize}\n\\end{frame}\n\n<<echo = F, cache = TRUE, eval = F, message = F, results = 'hide'>>=\n\n# clam and model data at D7\ndata(clams)\ndata(h3dat)\ndata(flow_dat)\nchld7 <- filter(h3dat, Site_Code %in% 'D7' & resvar %in% 'chl')$mod[[1]]\n\nclmdat <- group_by(clams, yr, species) %>% \n  dplyr::summarize(\n    clams_smp = mean(clams_smp, na.rm = TRUE),\n    biomass = mean(biomass, na.rm = TRUE)\n    ) %>% \n  ungroup %>% \n  mutate(yr = as.Date(paste0(yr, '-10-01')))\n\n# make sure date range is same on both\nxlims <- as.Date(c('1976-10-01', '2014-10-01'))\n\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    plot.margin = unit(c(3, 3, 3, 3), 'pt')\n  )   \n\n##\n# annual clam time series\np1 <- ggplot(clmdat, aes(x = yr, y = clams_smp, fill = species)) + \n  geom_bar(stat = 'identity') + \n  mytheme + \n  theme(\n    legend.position = 'top', \n    legend.title = element_blank(),\n    axis.title.x = element_blank()\n    ) + \n  scale_fill_brewer(\n    palette = 'Set2',\n    labels = parse(text = c('italic(Corbicula)', 'italic(Potamocorbula)'))\n    ) + \n  scale_x_date('Year', limits = xlims) +\n  scale_y_continuous('Clams per sample') +\n  guides(fill = guide_legend(keywidth = 0.5, keyheight = 0.5))\n\npdf('fig/d7clam.pdf', height = 2.5, width = 8.5, family = 'serif')\np1\ndev.off()\n\ndata(h3dat)\n\n# separate each site\ntoplo1 <- filter(h3dat, Site_Code %in% 'D7')\n\n# y axis labels\nylab1 <- expression(paste(\"DIN (mg \", L^-1, \")\"))\nylab2 <- expression(paste(\"Chl-\", italic(a), \" (\", italic(mu), \"g \", L^-1, \")\"))\nylab3 <- expression(paste(\"Si\", O[2], \" (mg \", L^-1, \")\"))\n\n# colors\ncols <- RColorBrewer::brewer.pal(9, 'Set1')[1:3]\ncol_vec <- RColorBrewer::brewer.pal(9, 'Blues')[c(9, 8, 7)]\n\n## first set of plots\npdin1 <- prdnrmplot(toplo1$mod[[2]], col_vec = col_vec, logspace = F, min_mo = 10) +\n  mytheme + \n  scale_y_continuous(ylab1) +\n  theme(\n    legend.position = 'none', \n    axis.title.x = element_blank()\n    )\n\npchl1 <- prdnrmplot(toplo1$mod[[1]], col_vec = col_vec, logspace = F, min_mo = 10) +\n  mytheme + \n  theme(\n    legend.position = 'none', \n    axis.title.x = element_blank()\n    ) + \n  scale_y_continuous(ylab2)\n\npsio1 <- prdnrmplot(toplo1$mod[[3]], col_vec = col_vec, logspace = F, min_mo = 10) +\n  mytheme + \n  theme(\n    legend.position = 'none', \n    axis.title.x = element_blank()\n    ) +\n  scale_y_continuous(ylab3)\n\n# Set the widths\npA1 <- ggplot_gtable(ggplot_build(pdin1))\npB1 <- ggplot_gtable(ggplot_build(pchl1))\npC1 <- ggplot_gtable(ggplot_build(psio1))\nmaxWidth = unit.pmax(pA1$widths[2:3], pB1$widths[2:3], pC1$widths[2:3])\npA1$widths[2:3] <- maxWidth\npB1$widths[2:3] <- maxWidth\npC1$widths[2:3] <- maxWidth\n\npdf('fig/d7prdnrm.pdf', height = 2, width = 4, family = 'serif')\ngrid.arrange(pA1)\ngrid.arrange(pB1)\ngrid.arrange(pC1)\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of biological invasion in Suisun Bay}}\n\\vspace{-0.1in}\n\\onslide<1->\n\\begin{figure}\n\\centerline{\\includegraphics[width = \\textwidth]{fig/d7clam.pdf}}\n\\caption{Clam density by year at D7, Suisun Bay \\cite{Crauder16}.}\n\\end{figure}\n\\vspace{-0.1in}\n\\begin{columns}\n\\begin{column}{0.35\\textwidth}\n\\onslide<2->{\n\\includegraphics[width = \\textwidth, page = 2]{fig/d7prdnrm.pdf}\n}\n\\end{column}\n\\begin{column}{0.35\\textwidth}\n\\onslide<3->{\n\\includegraphics[width = \\textwidth, page = 1]{fig/d7prdnrm.pdf}\n}\n\\end{column}\n\\begin{column}{0.35\\textwidth}\n\\onslide<4->{\n\\includegraphics[width = \\textwidth, page = 3]{fig/d7prdnrm.pdf}\n}\n\\end{column}\n\\end{columns}\n\\vspace{-0.05in}\n\\onslide<2->\n\\begin{figure}\n\\caption{Annual predicted (points) and flow-normalized (lines) water quality data at D7.}\n\\end{figure}\n\\end{frame}\n\n<<echo = F, cache = TRUE, eval = F, message = F, results = 'hide'>>=\n\n# clam and model data at D7\ndata(clams)\ndata(h3dat)\ndata(flow_dat)\nchld7 <- filter(h3dat, Site_Code %in% 'D7' & resvar %in% 'chl')$mod[[1]]\n\nclmdat <- group_by(clams, yr, species) %>% \n  dplyr::summarize(\n    clams_smp = mean(clams_smp, na.rm = TRUE),\n    biomass = mean(biomass, na.rm = TRUE)\n    ) %>% \n  ungroup %>% \n  mutate(yr = as.Date(paste0(yr, '-10-01')))\n\n# make sure date range is same on both\nxlims <- as.Date(c('1976-10-01', '2014-10-01'))\n\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    plot.margin = unit(c(3, 3, 3, 3), 'pt')\n  )   \n\n##\n# clam biomass related to daily sacramento flow\nclmdat <- group_by(clams, yr, species) %>% \n  dplyr::summarize(\n    clams_smp = mean(clams_smp, na.rm = TRUE),\n    biomass = mean(biomass, na.rm = TRUE)\n    ) %>% \n  ungroup %>% \n  mutate(yr = as.Date(paste0(yr, '-10-01')))\n\nflodat <- filter(flow_dat, station %in% 'sac')\nclmflo <- select(clams, biomass, clams_smp, species, date) %>% \n  rename(Date = date) %>% \n  left_join(., flodat, by = 'Date') %>% \n  filter(species %in% 'Potamocorbula')\n\n# linear model of concentration x biomass\nmod <- lm(log(1 + biomass) ~ log(1 + q), data = clmflo) %>% \n  coefficients\nxvals <- range(clmflo$q, na.rm = TRUE)\nxvals <- seq(xvals[1], xvals[2], length = 100)\nyvals <- (exp(mod[1] + mod[2] * log(1 + xvals))) - 1\n\nylab <- expression(paste(italic(Potamocorbula), \" biomass (g \", m^-2, \")\"))\nxlab <- expression(paste(\"Sacramento daily flow (\", m^3, ' ', s^-1, \")\"))\n\n# scatter plot of concentration x biomass with model \np1 <- ggplot(clmflo, aes(x = q, y = biomass)) + \n  geom_point(size = 3, alpha = 0.8, colour = 'darkgrey') + \n  geom_line(data = data.frame(x = xvals, y = yvals), aes(x, y, colour = 'black'), lwd = 1) +\n  mytheme +\n  theme(\n    legend.position = 'top', \n    legend.title = element_blank(), \n    legend.box = 'horizontal'\n    ) +\n  scale_colour_manual(label = 'log(1 + biomass) = 5.2 - 0.6log(1 + flow)', values = 'black') +\n  scale_x_continuous(xlab) + \n  scale_y_continuous(ylab, limits = c(0,15))\n\n##\n# chlorophyll by month\nchldat <- filter(h3dat, resvar %in% 'chl' & Site_Code %in% 'D7') %>% \n  .$mod %>% \n  .[[1]] %>% \n  select(year, month, res, bt_norm) %>% \n  mutate(res = exp(res)) %>% \n  rename(yr = year, mo = month, bt_res = res) %>% \n  group_by(yr, mo) %>% \n  dplyr::summarize(res = mean(bt_res, na.rm = TRUE), bt_norm = mean(bt_norm, na.rm = TRUE)) %>% \n  ungroup\n\n# clam by month\nclmdat <- mutate(clams, mo = lubridate::month(date)) %>% \n  group_by(yr, mo, species) %>% \n  dplyr::summarize(\n    clams_smp = mean(clams_smp, na.rm = TRUE),\n    biomass = mean(biomass, na.rm = TRUE)\n    ) %>% \n  ungroup %>% \n  filter(species %in% 'Potamocorbula')\n\n# combine chlorophyll and clam by year, month\ntoplo <- left_join(clmdat, chldat, by = c('yr', 'mo')) %>% \n  mutate(date = as.Date(paste0(yr, '-', mo, '-01')))\n\n# linear model of concentration x biomass\nmod <- lm(log(1 + bt_norm) ~ log(1 + biomass), data = toplo) %>% \n  coefficients\nxvals <- range(toplo$biomass, na.rm = TRUE)\nxvals <- seq(xvals[1], xvals[2], length = 100)\nyvals <- (exp(mod[1] + mod[2] * log(1 + xvals))) - 1\n\nxlab <- expression(paste(italic(Potamocorbula), \" biomass (g \", m^-2, \")\"))\nylab <- expression(paste(\"Flow-normalized chlorophyll (\", italic(mu), \"g \", L^-1, \")\"))\n\n# scatter plot of concetration x biomass with model \np2 <- ggplot(toplo, aes(x = biomass, y = bt_norm)) + \n  geom_point(size = 3, alpha = 0.8, colour = 'darkgrey') + \n  geom_line(data = data.frame(x = xvals, y = yvals), aes(x, y, colour = 'black'), lwd = 1) +\n  mytheme + \n  theme(\n    legend.position = 'top', \n    legend.title = element_blank(), \n    legend.box = 'horizontal'\n    ) +\n  scale_colour_manual(label = 'log(1 + chl) = 1.35 - 0.1log(1 + biomass)', values = 'black') +\n  scale_x_continuous(xlab) + \n  scale_y_continuous(ylab, limits = c(0.8, 4))\n\n##\n# dynaplot for chl, june\ncols <- RColorBrewer::brewer.pal(10, 'Set2')[1:2]\nylab <- attr(chld7, 'reslab')\n\np3 <- dynaplot(chld7, mo = 6, col_vec = cols, floscl = F) +\n  mytheme +\n  theme(\n    legend.position = 'top', \n    legend.title = element_blank(), \n    legend.box = 'horizontal',\n    strip.background = element_blank(),\n    strip.text.x = element_blank()\n    ) + \n  scale_x_continuous('ln-Salinity (psu)') + \n  scale_y_continuous(ylab, limits = c(0.4, 3.3)) +\n  guides(colour = guide_colourbar(barheight = 0.5, barwidth = 10))\n\n# align widths of plots in first column, first two\npA <- ggplot_gtable(ggplot_build(p1))\npB <- ggplot_gtable(ggplot_build(p2))\npC <- ggplot_gtable(ggplot_build(p3))\nmaxWidth = unit.pmax(pA$widths[2:3], pB$widths[2:3], pC$widths[2:3])\n\n# Set the widths\npA$widths[2:3] <- maxWidth\npB$widths[2:3] <- maxWidth\npC$widths[2:3] <- maxWidth\n\npdf('fig/d7flos.pdf', height = 2.75, width = 4.25, family = 'serif')\ngrid.arrange(pA)\ngrid.arrange(pB)\ngrid.arrange(pC)\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of biological invasion in Suisun Bay}}\n\\onslide<1->\n\\begin{columns}\n\\begin{column}{0.5\\textwidth}\n\\centerline{\\includegraphics[width = 0.95\\textwidth, page = 3]{fig/d7flos.pdf}}\n\\end{column}\n\\begin{column}{0.5\\textwidth}\n\\begin{itemize}\n\\item Early: Flow-stimulation, then flushing \\\\~\\\\\n\\item Later: Flow-stimulation\n\\end{itemize}\n\\end{column}\n\\end{columns}\n\\begin{columns}\n\\begin{column}{0.5\\textwidth}\n\\onslide<2->{\n\\centerline{\\includegraphics[width = 0.95\\textwidth, page = 2]{fig/d7flos.pdf}}\n}\n\\end{column}\n\\begin{column}{0.5\\textwidth}\n\\onslide<3->{\n\\centerline{\\includegraphics[width = 0.95\\textwidth, page = 1]{fig/d7flos.pdf}}\n}\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n<<echo = F, cache = TRUE, eval = F, message = F, results = 'hide'>>=\n\n# clam and model data at D7\ndata(clams)\ndata(h3dat)\ndata(flow_dat)\nchld7 <- filter(h3dat, Site_Code %in% 'D7' & resvar %in% 'chl')$mod[[1]]\n\nclmdat <- group_by(clams, yr, species) %>% \n  dplyr::summarize(\n    clams_smp = mean(clams_smp, na.rm = TRUE),\n    biomass = mean(biomass, na.rm = TRUE)\n    ) %>% \n  ungroup %>% \n  mutate(yr = as.Date(paste0(yr, '-10-01')))\n\n# make sure date range is same on both\nxlims <- as.Date(c('1976-10-01', '2014-10-01'))\n\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    plot.margin = unit(c(3, 3, 3, 3), 'pt'), \n    axis.title.x = element_blank()\n  )   \n\n##\n# annual clam time series\np1 <- ggplot(clmdat, aes(x = yr, y = clams_smp, fill = species)) + \n  geom_bar(stat = 'identity') + \n  mytheme + \n  theme(\n    legend.position = c(0.22, 0.82), \n    legend.title = element_blank(),\n    axis.title.x = element_blank(),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.direction = 'horizontal'\n    ) + \n  scale_fill_brewer(\n    palette = 'Set2',\n    labels = parse(text = c('italic(Corbicula)', 'italic(Potamocorbula)'))\n    ) + \n  scale_x_date('Year', limits = xlims) +\n  scale_y_continuous('Clams per sample') +\n  guides(fill = guide_legend(keywidth = 0.5, keyheight = 0.5))\n\n# separate each site\ntoplo1 <- filter(h3dat, Site_Code %in% 'D7')\n\n# y axis labels\nylab <- expression(paste(\"Chl-\", italic(a), \" (\", italic(mu), \"g \", L^-1, \")\"))\n\n# colors\ncols <- RColorBrewer::brewer.pal(9, 'Set1')[1:3]\ncol_vec <- RColorBrewer::brewer.pal(9, 'Blues')[c(9, 8, 7)]\n\n##\n# chlorophyll prdnrmplot\np2 <- prdnrmplot(toplo1$mod[[1]], col_vec = col_vec, logspace = F, min_mo = 10) +\n  mytheme + \n  theme(\n    legend.position = 'none'\n    ) + \n  scale_y_continuous(ylab) + \n  scale_x_date(limits = xlims)\n\n## flo with loess\nflow_dat <- mutate(flow_dat, \n    year = year(Date), \n    month = month(Date)\n  ) %>% \n  group_by(year, month) %>% \n  summarise(q = mean(q, na.rm = T)) %>% \n  unite('Date', year:month, sep = '-') %>% \n  mutate(\n    Date = paste0(Date, '-01'), \n    Date = as.Date(Date, format = '%Y-%m-%d')\n  ) %>% \n  arrange(Date)\n  \nylab <- expression(paste('ln-Flow (', m^3, ' ', s^-1, ')'))\np3 <- ggplot(flow_dat, aes(x = Date, y = log(q))) + \n  geom_line() +\n  stat_smooth(se = F, span = 0.25) + \n  mytheme + \n  scale_y_continuous(ylab) +\n  scale_x_date(limits = xlims)\n\n# Set the widths\npA <- ggplot_gtable(ggplot_build(p1))\npB <- ggplot_gtable(ggplot_build(p2))\npC <- ggplot_gtable(ggplot_build(p3))\nmaxWidth = unit.pmax(pA$widths[2:3], pB$widths[2:3], pC$widths[2:3])\npA$widths[2:3] <- maxWidth\npB$widths[2:3] <- maxWidth\npC$widths[2:3] <- maxWidth\n\npdf('fig/d7links.pdf', height = 1.5, width = 7.5, family = 'serif')\ngrid.arrange(pA)\ngrid.arrange(pB)\ngrid.arrange(pC)\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Selected case studies}}{\\textbf{Effects of biological invasion in Suisun Bay}}\n\\onslide<1->\n\\centerline{\\includegraphics[width = 0.97\\textwidth, page = 1]{fig/d7links.pdf}}\n\\onslide<2->\n\\centerline{\\includegraphics[width = 0.97\\textwidth, page = 2]{fig/d7links.pdf}}\n\\onslide<3->\n\\centerline{\\includegraphics[width = 0.97\\textwidth, page = 3]{fig/d7links.pdf}}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}[t]{\\textbf{Selected case studies}}{\\textbf{Effects of biological invasion in Suisun Bay}}\n\\onslide<1->\nResults at D7 show complex response of chlorophyll:\n\\vspace{0.05in}\n\\begin{columns}[t]\n\\begin{column}{0.5\\textwidth}\n\\vspace{0.2in}\n\\begin{itemize}\n\\onslide<1->{\n\\item Increase in clam abundance, decrease in chlorophyll \\\\~\\\\\n\\item Increase in DIN... but also decrease in SiO$_2$ \\\\~\\\\\n}\n\\onslide<2->{\n\\item Relationship with flow changed depending on physical or biological forcing\n}\n\\end{itemize}\n\\end{column}\n\\begin{column}{0.25\\textwidth}\n\n\\includegraphics<1>[width = \\textwidth, trim = 0mm -10mm 0mm 0mm, clip, page = 2]{fig/d7prdnrm.pdf}\n\n\\includegraphics<1>[width = \\textwidth, trim = 0mm -10mm 0mm 0mm, clip, page = 1]{fig/d7prdnrm.pdf}\n\n\\includegraphics<1>[width = \\textwidth, trim = 0mm -10mm 0mm 0mm, clip, page = 3]{fig/d7prdnrm.pdf}\n\\includegraphics<2>[width = \\textwidth, page = 3]{fig/d7flos.pdf}\n\n\\includegraphics<2>[width = \\textwidth, page = 2]{fig/d7flos.pdf}\n\n\\includegraphics<2>[width = \\textwidth, page = 1]{fig/d7flos.pdf}\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n\\section{Conclusions and future work}\n\n%%%%%%\n\\begin{frame}{\\textbf{Conclusions}}{\\textbf{Lessons for monitoring and future work}}\n\\onslide<+->\nMonitoring data are not particularly telling... \\\\\n...so we use models or other methods to \\emtxt{decompose} the observations \\\\~\\\\\n\\onslide<+->\nChosen method depends on the question: WRTDS because water quality varies with time, season, and flow \\\\~\\\\\n\\onslide<+->\n\\begin{itemize}\n\\item More complete description of trends\n\\item Better link to causal events\n\\item More comprehensive evaluation of site-specific issues\n\\item Deconstruct the past to predict the future\\\\~\\\\\n\\end{itemize}\n\\onslide<+->\n\\emtxt{WRTDStidal} package for R, active development\n\\href{https://github.com/fawda123/WRTDStidal}{\\url{https://github.com/fawda123/WRTDStidal}}\n\\end{frame}\n\n% patux map\n<<echo = F, cache = T, message = F, eval = F>>=\n\n# load data\ndata(cb_poly)\ndata(usa_poly)\ndata(patux_poly)\ndata(pax_meta)\ndata(cb_poly_simp)\n\n# lims <- bbox(patux_poly)\n\n# color palette\nmapcols <- RColorBrewer::brewer.pal(5, 'GnBu')\nbg_col <- '#F0F9E8'\n\n# prep for plots\ncb_poly <- fortify(cb_poly)\nusa_poly <- fortify(usa_poly)\npatux_poly <- fortify(patux_poly) %>% \n  mutate(id = factor(id, levels = c('60', '74', '88'), labels = c('TF', 'OH', 'MH')))\n\npax_meta$lab <- with(pax_meta, paste0('\"', STATION, ' (', round(dist_km, 1), ')\"'))\npax_meta$lab[c(4, 8)] <- paste0('bold(', pax_meta$lab[c(4, 8)], ')') \n\n# base map\np1 <- ggplot(patux_poly, aes(x = long, y = lat)) + \n  geom_polygon(data = cb_poly, aes(x = long, y = lat, group = group), \n    fill = 'grey90', colour = 'grey50') +\n  geom_polygon(aes(fill = factor(id), group = group), colour = NA) +\n  scale_fill_manual(values = rev(mapcols)) +\n  geom_point(data = pax_meta, aes(x = LONG, y = LAT), size = 5, alpha = 0.8) +\n  geom_text(data = pax_meta, aes(x = LONG * 1.001, y = LAT, label = lab), size = 5, \n    parse = TRUE) +\n  theme_classic() + \n  theme(axis.line=element_blank(), axis.text.x=element_blank(),\n    axis.text.y=element_blank(), axis.ticks=element_blank(),\n    axis.title.x=element_blank(),\n    axis.title.y=element_blank(),\n    panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),\n    panel.grid.minor=element_blank(),plot.background=element_blank(), \n    legend.position = 'top', \n    legend.title = element_blank(), \n    legend.background = element_rect(fill =  scales::alpha(bg_col, 0))\n    ) +\n  coord_fixed(ratio = 1, xlim = c(-76.84, -76.38), ylim = c(38.27, 38.88))\n\n\n# inset\np2 <- ggplot(patux_poly, aes(x = long, y = lat)) + \n  geom_polygon(data = usa_poly, aes(x = long, y = lat, group = group), \n    fill = 'white', colour = 'grey50') +\n  geom_polygon(aes(group = group), colour = 'black', fill = 'black') +\n  theme(axis.title =element_blank(), \n          axis.text.y = element_text(colour = 'black'), \n          axis.text.x = element_text(colour = 'black', angle = 90, vjust = 0.5), \n          panel.background=element_rect(fill = 'grey90'),\n          panel.grid.major=element_blank(),\n          panel.grid.minor=element_blank(),\n          plot.background=element_blank(),\n          panel.border = element_rect(colour = \"black\", fill = NA, size = 1)\n    ) +\n  coord_fixed(ratio = 1, xlim = c(-77.5, -75.5), ylim = c(36.7, 39.7))\n\ngrid.newpage()\nv1 <- viewport(width = 1, height = 1, x = 0.5, y = 0.5) \nv2 <- viewport(width = 0.55, height = 0.55, x = 0.7275, y = 0.64)\n\npdf('fig/patux_map.pdf', height = 7, width = 5, family = 'serif')\nprint(p1, vp = v1) \nprint(p2, vp = v2)\ndev.off()\n@\n\n% patux trends\n<<echo = F, cache = T, message = F, eval = F>>=\n\ndata(bestLE12)\ndata(bestTF16)\n\ncols <- RColorBrewer::brewer.pal(5, 'GnBu')\n\nmytheme <- theme_bw() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    strip.background = element_rect(fill = cols[2], colour = 'black'),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    plot.margin = unit(c(3, 3, 3, 3), 'pt')\n  )   \n\n# some plots\nbestTF16$site <- 'TF1.6'\nbestLE12$site <- 'LE1.2'\nnames(bestLE12) <- gsub('gams$', 'GAM', names(bestLE12))\nnames(bestLE12) <- gsub('wrtds$', 'WRTDS', names(bestLE12))\nnames(bestTF16) <- gsub('gams$', 'GAM', names(bestTF16))\nnames(bestTF16) <- gsub('wrtds$', 'WRTDS', names(bestTF16))\n\nbestLE12 <- select(bestLE12, -sal, -lnQ, -dec_time, -se_GAM)\nbestTF16 <- select(bestTF16, -lnQ, -sal, -dec_time, -se_GAM)\ntoplo <- rbind(bestTF16, bestLE12) %>% \n  gather(variable, value, fits_WRTDS:res_GAM) %>% \n  separate(variable, c('output', 'model'), sep = '_') %>% \n  mutate(output = factor(output, levels = c('fits', 'norm', 'res'), labels = c('Pred', 'Norm', 'Res')))\n\ntoplo2 <- mutate(toplo, year = as.numeric(strftime(date, '%Y'))) %>% \n  group_by(year, site, output, model) %>% \n  summarise(value = mean(value, na.rm = TRUE)) %>% \n  filter(output != 'Res') %>% \n  spread(output, value) \n\np2 <- ggplot(toplo2, aes(x = year, y = Pred, colour = 'Pred')) + \n  geom_line(aes(x = year, y = Norm, colour = 'Norm'), size = 1) + \n  geom_point() + \n  mytheme + \n  facet_wrap(site ~ model) + \n  theme(\n    axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5),\n    axis.title.x = element_blank(), \n    legend.title = element_blank(), \n    legend.position = 'top'\n    ) +\n  scale_y_continuous(limits = c(1.5, 3), breaks = seq(1.5, 3, 0.5)) + \n  scale_colour_manual(values = cols[c(5, 4)]) + \n  ylab(expression(paste('ln-Chl ',' (',italic('\\u03bc'),'g ',L^-1,')'))) +\n  guides(color=guide_legend(override.aes=list(shape=c(NA,16),linetype=c(1,0))))\n\npdf('fig/predann.pdf', height = 6, width = 7, family = 'serif')\nprint(p2)\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Conclusions}}{\\textbf{Lessons for monitoring and future work}}\nComparing WRTDS and GAMs for trend evaluation\n\\begin{columns}\n\\begin{column}{0.38\\textwidth}\n\\includegraphics[width = \\textwidth]{fig/patux_map.pdf}\n\\end{column}\n\\begin{column}{0.65\\textwidth}\n\\includegraphics[width = \\textwidth]{fig/predann.pdf}\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n<<echo = F, cache = T, message = F, eval = F>>=\ndata(RKBMB_wtreg)\nto_plo <- RKBMB_wtreg\n\npal <- RColorBrewer::brewer.pal(5, 'GnBu')\n\ndata(met_ls)\nmet_ls <- met_ls[['RKBMB_wtreg.RData']]\nmet_plo <- reshape2::melt(met_ls, id.var = 'Date', measure.var = c('Pg', 'Rt', 'Pg_dtd', 'Rt_dtd'))\nmet_plo$type <- rep('Observed', length = nrow(met_plo))\nmet_plo$type[grep('dtd$', met_plo$variable)] <- 'Detided'\nmet_plo$variable <- gsub('_dtd$', '', met_plo$variable)\nmet_plo$variable <- factor(met_plo$variable, levels = c('Pg', 'Rt'), labels = c('Production', 'Respiration'))\nmet_plo$type<- factor(met_plo$type, levels = c('Observed', 'Detided'), labels = c('Observed', 'Detided'))\n\nmytheme <- theme_minimal() + \n  theme(\n    plot.background = element_rect(fill='transparent', \n      colour = NA),\n    panel.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.background = element_rect(fill='transparent', \n      colour = NA),\n    legend.key = element_rect(fill = 'transparent', \n      colour = NA),\n    axis.line.x = element_line(), \n    axis.line.y = element_line(), \n    axis.ticks.x = element_line(),\n    axis.ticks.y = element_line(),\n    axis.ticks.length = unit(.1, \"cm\"), \n    panel.grid.major = element_line(colour = \"#7BCCC4\"),\n    panel.grid.minor = element_blank(), \n    plot.margin = unit(c(0, 0, 0, 0), 'pt')\n  )   \n\n## \n\nylab<-expression(paste('DO (mg ',L^-1,')'))\np1 <- ggplot(to_plo, aes(x = DateTimeStamp)) + \n  geom_line(aes(y = DO_obs, colour = 'Observed')) +\n  geom_line(aes(y = DO_nrm, colour = 'Detided')) +\n  scale_colour_manual('', values=pal[c(3, 5)]) +\n  scale_y_continuous(ylab) +\n  mytheme +\n  theme(legend.position = 'top', axis.title.x = element_blank())\n\nylab<-expression(paste('mmol ', O[2],' ', m^-2,' ', d^-1))\np2 <- ggplot(met_plo, aes(x = Date, y = value, group = variable, colour = variable)) + \n  geom_line() +\n  geom_point() +\n  facet_wrap(~type, ncol = 1) + \n  scale_colour_manual('', values=pal[c(3, 4)]) +\n  scale_y_continuous(ylab) +\n  mytheme + \n  theme(legend.position = 'top', axis.title.x = element_blank())\n\npdf('fig/metex.pdf', height = 5, width = 9, family = 'serif')\ngrid.arrange(p1, p2, ncol = 1, heights = c(1.5,2))\ndev.off()\n@\n\n%%%%%%\n\\begin{frame}{\\textbf{Conclusions}}{\\textbf{Lessons for monitoring and future work}}\nDO time series and ecosystem metabolism \\cite{Beck15b}\n\\includegraphics[width = \\textwidth]{fig/metex.pdf}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}{\\textbf{Conclusions}}{\\textbf{Lessons for monitoring and future work}}\nData management and analysis tools\n\\begin{center}\n\\fbox{\\includegraphics[width = 0.9\\textwidth]{fig/shinyex.png}}\n\\end{center}\n\\end{frame}\n\n%%%%%%\n\\begin{frame}\nAcknowledgments and contact info:\\\\~\\\\\n\\begin{columns}\n\\begin{column}{0.9\\textwidth}\n{\\footnotesize\nResearch staff and employees at USEPA Gulf Ecology Division, San Francisco Estuary Institute \\\\~\\\\\nDavid Senn, Phil Bresnahan, Emily Novick, James D. Hagy III, Thomas Jabusch\n}\n\\end{column}\n\\end{columns}\n\\vfill\n\\begin{columns}\n\\begin{column}{0.5\\textwidth}\n\\begin{center}\n\\includegraphics[width=0.7\\linewidth]{fig/titlegraphic.png}\n\\end{center}\n\\end{column}\n\\begin{column}{0.5\\textwidth}\n\\scriptsize\n\\begin{center}\n\\href{mailto:beck.marcus@epa.gov}{beck.marcus@epa.gov} \\\\~\\\\\nGithub @fawda123 \\\\~\\\\\nPhone: 8509342480\n\\end{center}\n\\end{column}\n\\end{columns}\n\\vfill\nLinks:\\\\~\\\\\n\\begin{columns}\n\\begin{column}{0.9\\textwidth}\n\\scriptsize\nThis presentation: \\href{https://github.com/fawda123/sfei_pres}{\\url{https://github.com/fawda123/sfei\\_pres}}\n\nShiny app: \\href{https://beckmw.shinyapps.io/sf_trends/}{\\url{https://beckmw.shinyapps.io/sf_trends/}}\n\nDetailed results: \\href{http://fawda123.github.io/sf_trends/README}{\\url{http://fawda123.github.io/sf\\_trends/README}}\n\\end{column}\n\\end{columns}\n\\end{frame}\n\n%%%%%%\n\\section{References}\n\\begin{frame}[t]{\\textbf{References}}\n\\tiny\n\\setbeamertemplate{bibliography item}{}\n\\bibliographystyle{apalike_mine}\n\\bibliography{refs}\n\\end{frame}\n\n\\end{document}",
    "created" : 1474638646441.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "253|68|368|1|\n",
    "hash" : "2946354233",
    "id" : "422321EA",
    "lastKnownWriteTime" : 1472045522,
    "path" : "M:/presentations/sfei_pres/sfei_pres.Rnw",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "sweave"
}